'use client';

import { useSortable } from '@dnd-kit/sortable';
import { CSS } from '@dnd-kit/utilities';
import { Widget } from '../types';
import { GripVertical, X, Settings } from 'lucide-react';
import TimeWidget from './widgets/TimeWidget';
import TodoWidget from './widgets/TodoWidget';
import YoutubeWidget from './widgets/YoutubeWidget';
import PomodoroWidget from './widgets/PomodoroWidget';
import WeatherWidget from './widgets/WeatherWidget';
import SpotifyWidget from './widgets/SpotifyWidget';
import SpacerWidget from './widgets/SpacerWidget';

interface WidgetWrapperProps {
    widget: Widget;
    totalInColumn: number;
    isEditing: boolean;
    blur?: number;
    onRemove: (id: string) => void;
    onUpdatePosition: (id: string, position: 'top' | 'middle' | 'bottom' | 'auto') => void;
    onUpdateSettings: (id: string, settings: any) => void;
}

// Helper function to determine height based on total widgets in column
const getTotalHeight = (totalInColumn: number) => {
    if (totalInColumn === 1) return '100%';
    if (totalInColumn === 2) return '50%';
    if (totalInColumn === 3) return '33.33%';
    return 'auto'; // Default or for more than 3
};

export function WidgetWrapper({
  widget,
  totalInColumn,
  isEditing,
  blur,
  onRemove,
  onUpdatePosition,
  onUpdateSettings
}: WidgetWrapperProps) {
  const {
    attributes,
    listeners,
    setNodeRef,
    transform,
    transition,
    isDragging
  } = useSortable({ id: widget.id, data: { widget } });

  const style = {
    transform: CSS.Translate.toString(transform),
    transition,
    height: widget.customHeight ? `${widget.customHeight}%` : getTotalHeight(totalInColumn),
    zIndex: isDragging ? 100 : 'auto',
  };

  // Font scaling factor (default to 1)
  const fontSizeFactor = widget.settings?.fontSizeFactor || 1;

  // Firefox-compatible scaling:
  // scale() zooms the content
  // width/height compensation ensures the container flows correctly within the parent
  const contentStyle = {
    width: `calc(100% / ${fontSizeFactor})`,
    height: `calc(100% / ${fontSizeFactor})`,
    transform: `scale(${fontSizeFactor})`,
    transformOrigin: 'top left',
  };

  // Common props for widgets
  const widgetProps: any = {
      settings: widget.settings,
      onSettingsChange: (newSettings: any) => onUpdateSettings(widget.id, newSettings),
      blur,
      isEditing // Pass isEditing to all widgets
  };

  const handleFontSizeChange = (e: React.ChangeEvent<HTMLInputElement>) => {
      const newVal = parseFloat(e.target.value);
      onUpdateSettings(widget.id, { fontSizeFactor: newVal });
  };

  // Content for the widget
  const renderContent = () => {
    switch (widget.type) {
      case 'time': return <TimeWidget {...widgetProps} />;
      case 'todo': return <TodoWidget {...widgetProps} />;
      case 'youtube': return <YoutubeWidget {...widgetProps} />;
      case 'pomodoro': return <PomodoroWidget {...widgetProps} />;
      case 'weather': return <WeatherWidget {...widgetProps} />;
      case 'spotify': return <SpotifyWidget {...widgetProps} />;
      case 'spotify_hidden': return <SpotifyWidget {...widgetProps} isHidden={true} />;
      case 'spacer': return <SpacerWidget isEditing={isEditing} />;
      default: return null;
    }
  };

  if (widget.type === 'spacer') {
       return (
            <div ref={setNodeRef} style={style} {...attributes} {...listeners} className="w-full relative group p-2">
                 {renderContent()}
                 {isEditing && (
                    <button 
                        onClick={() => onRemove(widget.id)}
                        className="absolute top-2 right-2 bg-red-500 rounded-full p-1 text-white opacity-0 group-hover:opacity-100 transition shadow-lg z-50"
                        onPointerDown={e => e.stopPropagation()} 
                    >
                        <X size={12} />
                    </button>
                 )}
            </div>
       )
    }

  return (
    <div 
      ref={setNodeRef} 
      style={style} 
      className={`w-full transition-all duration-300 relative flex flex-col p-2 ${isDragging ? 'opacity-50' : ''}`}
      {...attributes} 
    >
      <div className={`relative w-full h-full group ${isEditing ? 'border-2 border-dashed border-white/30 rounded-xl' : ''} overflow-hidden`}>
        
        {/* Widget Content Wrapper for Scaling */}
        <div style={contentStyle} className="w-full h-full">
            {renderContent()}
        </div>

        {/* Edit Controls */}
        {isEditing && (
          <div className="absolute top-2 right-2 flex flex-col items-end gap-2 z-20 opacity-0 group-hover:opacity-100 transition-opacity">
             <div className="flex gap-2">
                <div {...listeners} className="p-1 bg-black/50 rounded-md cursor-grab active:cursor-grabbing text-white">
                    <GripVertical size={16} />
                </div>
                <button onClick={() => onRemove(widget.id)} className="p-1 bg-red-500/80 rounded-md text-white hover:bg-red-600">
                    <X size={16} />
                </button>
             </div>
             
             {/* Font Size Slider */}
             <div className="bg-black/80 p-2 rounded-lg flex flex-col gap-1 items-center" onPointerDown={e => e.stopPropagation()}>
                <label className="text-[10px] text-white/70 uppercase font-bold">Size</label>
                <input 
                    type="range" 
                    min="0.5" 
                    max="3.0" 
                    step="0.1" 
                    value={fontSizeFactor}
                    onChange={handleFontSizeChange}
                    className="w-20 accent-blue-500 h-1"
                />
                <span className="text-[10px] text-white">{fontSizeFactor.toFixed(1)}x</span>
             </div>
          </div>
        )}
      </div>
    </div>
  );
}
